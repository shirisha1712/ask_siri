{% extends "base.html" %}

{% block title %}AI Assistant - Ask Siri{% endblock %}

{% block content %}
<div class="container my-4">
    <!-- Assistant Header -->
    <div class="row mb-4">
        <div class="col-12 text-center">
            <h1 class="text-aqua">AI Log Analysis Assistant</h1>
            <p class="text-muted">Chat with our AI to get insights about your logs and troubleshooting guidance</p>
        </div>
    </div>

    <div class="row">
        <!-- Chat Interface -->
        <div class="col-lg-8">
            <div class="chat-container">
                <!-- Chat Header -->
                <div class="chat-header">
                    <div class="d-flex align-items-center">
                        <div class="assistant-avatar me-3">
                            <img src="{{ url_for('static', filename='images/siri-logo.png') }}" alt="Siri Logo" class="logo-icon">
                        </div>
                        <div>
                            <h5 class="mb-0">Ask Siri Assistant</h5>
                            <small class="text-muted">
                                <span id="typingIndicator" class="d-none">
                                    <i class="fas fa-circle typing-dot"></i>
                                    <i class="fas fa-circle typing-dot"></i>
                                    <i class="fas fa-circle typing-dot"></i>
                                    Typing...
                                </span>
                                <span id="statusIndicator">Online - Ready to help</span>
                            </small>
                        </div>
                        <div class="ms-auto">
                            <button id="clearChat" class="btn btn-outline-secondary btn-sm">
                                <i class="fas fa-trash me-1"></i>Clear Chat
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Chat Messages -->
                <div id="chatMessages" class="chat-messages">
                    <!-- Welcome Message -->
                    <div class="message assistant-message">
                        <div class="message-avatar">
                            <img src="{{ url_for('static', filename='images/siri-logo.png') }}" alt="Siri Logo" class="logo-icon">
                        </div>
                        <div class="message-content">
                            <div class="message-bubble">
                                <p>👋 Hello! I'm your AI log analysis assistant. I can help you:</p>
                                <ul class="list-unstyled mb-0">
                                    <li>• Analyze log patterns and identify issues</li>
                                    <li>• Explain error messages and their causes</li>
                                    <li>• Suggest troubleshooting steps</li>
                                    <li>• Provide best practices for log management</li>
                                </ul>
                                <p class="mb-0 mt-2">What can I help you with today?</p>
                            </div>
                            <div class="message-time">Just now</div>
                        </div>
                    </div>
                </div>

                <!-- Chat Input -->
                <div class="chat-input">
                    <form id="chatForm" class="d-flex gap-2">
                        <div class="input-group">
                            <textarea 
                                id="messageInput" 
                                class="form-control" 
                                placeholder="Type your question about logs, errors, or troubleshooting..."
                                rows="1"
                                style="resize: none;"
                            ></textarea>
                            <button type="button" class="btn btn-outline-primary" id="voiceButton" title="Voice Input">
                                <i class="fas fa-microphone" id="voiceIcon"></i>
                            </button>
                            <button type="button" class="btn btn-outline-secondary" id="speakToggle" title="Toggle Speech">
                                <i class="fas fa-volume-up" id="speakIcon"></i>
                            </button>
                            <button type="submit" class="btn btn-primary" id="sendButton">
                                <i class="fas fa-paper-plane"></i>
                            </button>
                        </div>
                    </form>
                    
                    <!-- Voice Status -->
                    <div id="voiceStatus" class="mt-2" style="display: none;">
                        <small class="text-info">
                            <i class="fas fa-microphone-alt me-1"></i>
                            <span id="voiceStatusText">Listening...</span>
                        </small>
                    </div>
                    
                    <!-- Quick Questions -->
                    <div class="quick-questions mt-2">
                        <small class="text-muted">Quick questions:</small>
                        <div class="d-flex flex-wrap gap-1 mt-1">
                            <button class="btn btn-outline-secondary btn-sm quick-question" data-question="What do 500 errors mean?">
                                500 errors
                            </button>
                            <button class="btn btn-outline-secondary btn-sm quick-question" data-question="How to troubleshoot database connection issues?">
                                DB connections
                            </button>
                            <button class="btn btn-outline-secondary btn-sm quick-question" data-question="What are the most common log patterns?">
                                Log patterns
                            </button>
                            <button class="btn btn-outline-secondary btn-sm quick-question" data-question="How to set up log rotation?">
                                Log rotation
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Assistant Panel -->
        <div class="col-lg-4">
            <!-- Context Panel -->
            <div class="server-card mb-4">
                <h5 class="text-aqua mb-3">
                    <i class="fas fa-lightbulb me-2"></i>Context & Tips
                </h5>
                <div id="contextPanel">
                    <div class="context-item">
                        <h6 class="text-primary">💡 Pro Tip</h6>
                        <p class="small mb-2">
                            Be specific about your log analysis needs. Mention error codes, 
                            timestamps, or specific symptoms for better assistance.
                        </p>
                    </div>
                    <div class="context-item">
                        <h6 class="text-success">🎯 Best Practice</h6>
                        <p class="small mb-2">
                            Include relevant log snippets in your questions to get 
                            more accurate analysis and recommendations.
                        </p>
                    </div>
                </div>
            </div>

            <!-- Analysis History -->
            <div class="server-card mb-4">
                <h5 class="text-aqua mb-3">
                    <i class="fas fa-history me-2"></i>Recent Analysis
                </h5>
                <div id="analysisHistory">
                    <div class="text-center text-muted py-3">
                        <i class="fas fa-chart-line fa-2x mb-2"></i>
                        <p class="small">No recent analysis<br>Upload logs to see insights here</p>
                    </div>
                </div>
            </div>

            <!-- Knowledge Base Quick Links -->
            <div class="server-card">
                <h5 class="text-aqua mb-3">
                    <i class="fas fa-book me-2"></i>Quick References
                </h5>
                <div class="knowledge-links">
                    <a href="{{ url_for('knowledge_detail', topic='common-errors') }}" class="knowledge-link">
                        <i class="fas fa-exclamation-triangle text-danger me-2"></i>
                        Common Error Codes
                    </a>
                    <a href="{{ url_for('knowledge_detail', topic='log-types') }}" class="knowledge-link">
                        <i class="fas fa-layer-group text-info me-2"></i>
                        Log File Types
                    </a>
                    <a href="{{ url_for('knowledge_detail', topic='troubleshooting') }}" class="knowledge-link">
                        <i class="fas fa-tools text-warning me-2"></i>
                        Troubleshooting Guide
                    </a>
                    <a href="{{ url_for('knowledge_detail', topic='best-practices') }}" class="knowledge-link">
                        <i class="fas fa-star text-success me-2"></i>
                        Best Practices
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- File Upload Modal for Chat -->
<div class="modal fade" id="uploadModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content bg-dark">
            <div class="modal-header border-secondary">
                <h5 class="modal-title text-aqua">Upload Log File</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="drop-zone" id="chatDropZone">
                    <i class="fas fa-cloud-upload-alt fa-3x text-muted mb-3"></i>
                    <p>Drop your log file here or click to browse</p>
                    <input type="file" id="chatFileInput" accept=".log,.txt,.json" style="display: none;">
                </div>
                <div class="mt-3">
                    <small class="text-muted">
                        Supported formats: .log, .txt, .json (max 10MB)
                    </small>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let chatHistory = [];
let isTyping = false;

document.addEventListener('DOMContentLoaded', function() {
    console.log('🤖 Ask Siri Assistant page loaded');
    console.log('🔧 Initializing chat interface...');
    
    setupChatInterface();
    loadChatHistory();
    setupFileUpload();
    
    // Add a test button for debugging
    const chatHeader = document.querySelector('.chat-header .ms-auto');
    if (chatHeader) {
        const testButton = document.createElement('button');
        testButton.className = 'btn btn-outline-info btn-sm me-2';
        testButton.innerHTML = '<i class="fas fa-flask"></i> Test API';
        testButton.onclick = function() {
            console.log('🧪 Testing API connection...');
            fetch('/api/chat', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ message: 'Hello, testing API connection' })
            })
            .then(response => response.json())
            .then(data => {
                console.log('✅ API Test successful:', data);
                alert('✅ API Connection Test Successful!');
            })
            .catch(error => {
                console.error('❌ API Test failed:', error);
                alert('❌ API Connection Test Failed: ' + error.message);
            });
        };
        chatHeader.prepend(testButton);
    }
    
    console.log('✅ Chat interface initialized successfully');
});

function setupChatInterface() {
    const chatForm = document.getElementById('chatForm');
    const messageInput = document.getElementById('messageInput');
    const sendButton = document.getElementById('sendButton');
    
    // Handle form submission
    chatForm.addEventListener('submit', function(e) {
        e.preventDefault();
        sendMessage();
    });
    
    // Handle Enter key (Shift+Enter for new line)
    messageInput.addEventListener('keydown', function(e) {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            sendMessage();
        }
    });
    
    // Auto-resize textarea
    messageInput.addEventListener('input', function() {
        this.style.height = 'auto';
        this.style.height = Math.min(this.scrollHeight, 120) + 'px';
    });
    
    // Quick questions
    document.querySelectorAll('.quick-question').forEach(button => {
        button.addEventListener('click', function() {
            const question = this.dataset.question;
            messageInput.value = question;
            sendMessage();
        });
    });
    
    // Clear chat
    document.getElementById('clearChat').addEventListener('click', clearChat);
}

function sendMessage() {
    const messageInput = document.getElementById('messageInput');
    const message = messageInput.value.trim();
    
    if (!message || isTyping) {
        console.log('⚠️ Cannot send message:', !message ? 'empty message' : 'already typing');
        return;
    }
    
    console.log('📤 Sending message:', message);
    
    // Add user message
    addMessage('user', message);
    messageInput.value = '';
    messageInput.style.height = 'auto';
    
    // Show typing indicator
    showTypingIndicator();
    
    // Send to actual AI API
    console.log('🚀 Calling /api/chat endpoint...');
    fetch('/api/chat', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ message: message })
    })
    .then(response => {
        console.log('📡 API Response status:', response.status, response.statusText);
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        return response.json();
    })
    .then(data => {
        console.log('📨 API Response data:', data);
        hideTypingIndicator();
        
        // Add AI response
        if (data.response) {
            addMessage('assistant', data.response);
            console.log('✅ AI response added to chat');
        } else if (data.error) {
            addMessage('assistant', `⚠️ Error: ${data.error}`);
            console.log('⚠️ API returned error:', data.error);
        }
        
        // Update context panel
        updateContextPanel(message);
    })
    .catch(error => {
        hideTypingIndicator();
        console.error('❌ Chat API Error:', error);
        
        // Show error message to user
        addMessage('assistant', `
            <div style="color: #dc3545; padding: 12px; border-left: 4px solid #dc3545; background: #f8d7da; border-radius: 8px;">
                <strong>⚠️ Connection Error</strong><br>
                I'm having trouble connecting to the AI service. Please check:
                <ul style="margin: 8px 0;">
                    <li>Your internet connection</li>
                    <li>Server status</li>
                    <li>Try refreshing the page</li>
                </ul>
                Error details: ${error.message}
            </div>
        `);
    });
}

function addMessage(sender, content, timestamp = null) {
    const chatMessages = document.getElementById('chatMessages');
    const messageDiv = document.createElement('div');
    const time = timestamp || new Date();
    
    messageDiv.className = `message ${sender}-message`;
    
    if (sender === 'user') {
        messageDiv.innerHTML = `
            <div class="message-content">
                <div class="message-bubble user-bubble">
                    ${content}
                </div>
                <div class="message-time">${formatTime(time)}</div>
            </div>
            <div class="message-avatar user-avatar">
                <i class="fas fa-user"></i>
            </div>
        `;
    } else {
        messageDiv.innerHTML = `
            <div class="message-avatar">
                <img src="{{ url_for('static', filename='images/siri-logo.png') }}" alt="Siri Logo" class="logo-icon">
            </div>
            <div class="message-content">
                <div class="message-bubble">
                    ${content}
                </div>
                <div class="message-time">${formatTime(time)}</div>
            </div>
        `;
    }
    
    chatMessages.appendChild(messageDiv);
    scrollToBottom();
    
    // Save to history
    chatHistory.push({
        sender: sender,
        content: content,
        timestamp: time.toISOString()
    });
    saveChatHistory();
}

function showTypingIndicator() {
    isTyping = true;
    document.getElementById('typingIndicator').classList.remove('d-none');
    document.getElementById('statusIndicator').classList.add('d-none');
    document.getElementById('sendButton').disabled = true;
}

function hideTypingIndicator() {
    isTyping = false;
    document.getElementById('typingIndicator').classList.add('d-none');
    document.getElementById('statusIndicator').classList.remove('d-none');
    document.getElementById('sendButton').disabled = false;
}

function updateContextPanel(userMessage) {
    // Update context panel with relevant tips based on user's question
    const contextPanel = document.getElementById('contextPanel');
    const lowerMessage = userMessage.toLowerCase();
    
    let contextHTML = '';
    
    if (lowerMessage.includes('error') || lowerMessage.includes('500') || lowerMessage.includes('404')) {
        contextHTML = `
            <div class="context-item">
                <h6 class="text-danger">🚨 Error Analysis</h6>
                <p class="small mb-2">
                    When analyzing errors, focus on timestamps, frequency patterns, and preceding events.
                    Look for correlations with deployments or system changes.
                </p>
            </div>
        `;
    } else if (lowerMessage.includes('performance') || lowerMessage.includes('slow') || lowerMessage.includes('timeout')) {
        contextHTML = `
            <div class="context-item">
                <h6 class="text-warning">⚡ Performance Insights</h6>
                <p class="small mb-2">
                    Performance issues often show gradual degradation patterns. 
                    Monitor response times, memory usage, and database query performance.
                </p>
            </div>
        `;
    } else {
        contextHTML = `
            <div class="context-item">
                <h6 class="text-primary">💡 Pro Tip</h6>
                <p class="small mb-2">
                    Be specific about your log analysis needs. Mention error codes, 
                    timestamps, or specific symptoms for better assistance.
                </p>
            </div>
            <div class="context-item">
                <h6 class="text-success">🎯 Best Practice</h6>
                <p class="small mb-2">
                    Include relevant log snippets in your questions to get 
                    more accurate analysis and recommendations.
                </p>
            </div>
        `;
    }
    
    contextPanel.innerHTML = contextHTML;
}

// Removed getContextualResponse function - now using real AI API

function updateContextPanel(userMessage) {
    const contextPanel = document.getElementById('contextPanel');
    
    // Add context based on the conversation
    const contextItem = document.createElement('div');
    contextItem.className = 'context-item';
    contextItem.innerHTML = `
        <h6 class="text-info">💬 Related Topics</h6>
        <p class="small mb-2">
            Based on your question, you might also be interested in learning about 
            error classification, log aggregation, and monitoring strategies.
        </p>
    `;
    
    // Keep only the last 3 context items
    if (contextPanel.children.length >= 3) {
        contextPanel.removeChild(contextPanel.firstChild);
    }
    
    contextPanel.appendChild(contextItem);
}

function clearChat() {
    const chatMessages = document.getElementById('chatMessages');
    chatMessages.innerHTML = `
        <div class="message assistant-message">
            <div class="message-avatar">
                <img src="{{ url_for('static', filename='images/siri-logo.png') }}" alt="Siri Logo" class="logo-icon">
            </div>
            <div class="message-content">
                <div class="message-bubble">
                    <p>Chat cleared! How can I help you with log analysis today?</p>
                </div>
                <div class="message-time">Just now</div>
            </div>
        </div>
    `;
    
    chatHistory = [];
    saveChatHistory();
}

function scrollToBottom() {
    const chatMessages = document.getElementById('chatMessages');
    chatMessages.scrollTop = chatMessages.scrollHeight;
}

function formatTime(date) {
    return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
}

function saveChatHistory() {
    localStorage.setItem('askSiriChatHistory', JSON.stringify(chatHistory));
}

function loadChatHistory() {
    const saved = localStorage.getItem('askSiriChatHistory');
    if (saved) {
        chatHistory = JSON.parse(saved);
        // Optionally restore recent messages
        if (chatHistory.length > 0) {
            // Show last few messages
            const recentMessages = chatHistory.slice(-5);
            const chatMessages = document.getElementById('chatMessages');
            
            recentMessages.forEach(msg => {
                if (msg.sender !== 'assistant' || chatMessages.children.length === 1) {
                    const messageDiv = document.createElement('div');
                    messageDiv.className = `message ${msg.sender}-message`;
                    
                    if (msg.sender === 'user') {
                        messageDiv.innerHTML = `
                            <div class="message-content">
                                <div class="message-bubble user-bubble">
                                    ${msg.content}
                                </div>
                                <div class="message-time">${formatTime(new Date(msg.timestamp))}</div>
                            </div>
                            <div class="message-avatar user-avatar">
                                <i class="fas fa-user"></i>
                            </div>
                        `;
                    } else {
                        messageDiv.innerHTML = `
                            <div class="message-avatar">
                                <img src="{{ url_for('static', filename='images/siri-logo.png') }}" alt="Siri Logo" class="logo-icon">
                            </div>
                            <div class="message-content">
                                <div class="message-bubble">
                                    ${msg.content}
                                </div>
                                <div class="message-time">${formatTime(new Date(msg.timestamp))}</div>
                            </div>
                        `;
                    }
                    
                    chatMessages.appendChild(messageDiv);
                }
            });
            
            scrollToBottom();
        }
    }
}

function setupFileUpload() {
    // This would handle file uploads for analysis within the chat
    const dropZone = document.getElementById('chatDropZone');
    const fileInput = document.getElementById('chatFileInput');
    
    if (dropZone && fileInput) {
        dropZone.addEventListener('click', () => fileInput.click());
        
        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.classList.add('drag-over');
        });
        
        dropZone.addEventListener('dragleave', () => {
            dropZone.classList.remove('drag-over');
        });
        
        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('drag-over');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleFileUpload(files[0]);
            }
        });
        
        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                handleFileUpload(e.target.files[0]);
            }
        });
    }
}

function handleFileUpload(file) {
    addMessage('user', `📁 Uploaded file: ${file.name} (${(file.size / 1024).toFixed(1)} KB)`);
    
    // Simulate file analysis
    showTypingIndicator();
    setTimeout(() => {
        const response = `<p>✅ <strong>File Analysis Complete!</strong></p>
        <p>I've analyzed <code>${file.name}</code> and found:</p>
        <ul>
            <li><strong>Log entries:</strong> ~${Math.floor(Math.random() * 1000) + 100}</li>
            <li><strong>Error messages:</strong> ${Math.floor(Math.random() * 50)}</li>
            <li><strong>Warning messages:</strong> ${Math.floor(Math.random() * 100)}</li>
        </ul>
        <p>What specific aspect would you like me to analyze further?</p>`;
        
        hideTypingIndicator();
        addMessage('assistant', response);
        
        // Close modal
        const modal = bootstrap.Modal.getInstance(document.getElementById('uploadModal'));
        if (modal) modal.hide();
    }, 2000);
}
</script>
{% endblock %}
