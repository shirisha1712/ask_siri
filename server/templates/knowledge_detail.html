{% extends "base.html" %}

{% block title %}{{ article_title }} - Knowledge Base - Ask Siri{% endblock %}

{% block content %}
<div class="container my-5">
    <!-- Article Header -->
    <div class="row mb-4">
        <div class="col-12">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="{{ url_for('index') }}">Home</a></li>
                    <li class="breadcrumb-item"><a href="{{ url_for('knowledge') }}">Knowledge Base</a></li>
                    <li class="breadcrumb-item active">{{ article_title }}</li>
                </ol>
            </nav>
        </div>
    </div>

    <div class="row">
        <!-- Article Content -->
        <div class="col-lg-8">
            <article class="knowledge-article">
                <!-- Article Meta -->
                <div class="article-meta mb-4">
                    <div class="d-flex align-items-center gap-3 mb-3">
                        <span class="badge bg-primary">{{ category.title() }}</span>
                        <span class="text-muted">{{ read_time }} min read</span>
                        <span class="text-muted">Updated {{ last_updated }}</span>
                    </div>
                    <h1 class="article-title text-aqua">{{ article_title }}</h1>
                    <p class="article-subtitle text-muted">{{ article_subtitle }}</p>
                </div>

                <!-- Article Content based on topic -->
                {% if topic == 'what-are-logs' %}
                <div class="article-content">
                    <h2>Understanding Log Files</h2>
                    <p class="lead">Log files are chronological records of events that occur within computer systems, applications, and networks. They serve as a detailed audit trail of system behavior and are essential for monitoring, debugging, and maintaining system health.</p>

                    <h3>What Makes a Good Log Entry?</h3>
                    <p>Effective log entries contain four key components:</p>
                    <ul>
                        <li><strong>Timestamp:</strong> Precise time when the event occurred</li>
                        <li><strong>Log Level:</strong> Severity or importance of the event</li>
                        <li><strong>Context:</strong> Source component or module</li>
                        <li><strong>Message:</strong> Clear description of what happened</li>
                    </ul>

                    <h3>Log Level Hierarchy</h3>
                    <div class="log-levels">
                        <div class="log-level-item error">
                            <strong>ERROR</strong> - Critical issues requiring immediate attention
                        </div>
                        <div class="log-level-item warning">
                            <strong>WARN</strong> - Potential problems that should be monitored
                        </div>
                        <div class="log-level-item info">
                            <strong>INFO</strong> - General operational information
                        </div>
                        <div class="log-level-item debug">
                            <strong>DEBUG</strong> - Detailed diagnostic information
                        </div>
                    </div>

                    <h3>Common Log Formats</h3>
                    <h4>Apache Access Log Format</h4>
                    <pre><code>192.168.1.100 - - [15/Jan/2024:14:30:25 +0000] "GET /api/users HTTP/1.1" 200 1234 "https://example.com" "Mozilla/5.0..."</code></pre>

                    <h4>Application Log Format</h4>
                    <pre><code>2024-01-15 14:30:25.123 [INFO ] [UserService] - User authentication successful for user: john.doe@example.com
2024-01-15 14:30:26.456 [ERROR] [DatabaseService] - Connection timeout after 30 seconds
2024-01-15 14:30:27.789 [WARN ] [CacheService] - Cache hit ratio below threshold: 65%</code></pre>

                    <h4>Structured JSON Log Format</h4>
                    <pre><code>{
  "timestamp": "2024-01-15T14:30:25.123Z",
  "level": "INFO",
  "service": "user-auth",
  "message": "User login successful",
  "metadata": {
    "userId": "12345",
    "ipAddress": "192.168.1.100",
    "sessionId": "abc123"
  }
}</code></pre>

                    <h3>Why Logs Matter</h3>
                    <div class="row g-3 mt-3">
                        <div class="col-md-6">
                            <div class="benefit-card">
                                <h5><i class="fas fa-bug text-danger me-2"></i>Debugging</h5>
                                <p>Quickly identify and resolve application issues</p>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="benefit-card">
                                <h5><i class="fas fa-shield-alt text-success me-2"></i>Security</h5>
                                <p>Detect unauthorized access and security breaches</p>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="benefit-card">
                                <h5><i class="fas fa-chart-line text-info me-2"></i>Performance</h5>
                                <p>Monitor system performance and resource usage</p>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="benefit-card">
                                <h5><i class="fas fa-clipboard-check text-warning me-2"></i>Compliance</h5>
                                <p>Meet regulatory requirements and audit trails</p>
                            </div>
                        </div>
                    </div>
                </div>

                {% elif topic == 'log-types' %}
                <div class="article-content">
                    <h2>Comprehensive Guide to Log Types</h2>
                    <p class="lead">Different systems generate different types of logs, each serving specific purposes in monitoring and troubleshooting. Understanding these log types is crucial for effective system administration.</p>

                    <h3>1. System Logs</h3>
                    <p>Operating system and kernel-level events, hardware status, and system service activities.</p>
                    
                    <h4>Linux System Logs</h4>
                    <ul>
                        <li><strong>/var/log/syslog:</strong> General system messages</li>
                        <li><strong>/var/log/kern.log:</strong> Kernel messages</li>
                        <li><strong>/var/log/auth.log:</strong> Authentication events</li>
                        <li><strong>/var/log/boot.log:</strong> Boot process messages</li>
                    </ul>

                    <h4>Windows System Logs</h4>
                    <ul>
                        <li><strong>System Log:</strong> Hardware and system component events</li>
                        <li><strong>Application Log:</strong> Application-specific events</li>
                        <li><strong>Security Log:</strong> Logon/logoff and resource access</li>
                    </ul>

                    <h3>2. Application Logs</h3>
                    <p>Application-specific events, errors, and operational information.</p>
                    <div class="code-example">
                        <h5>Example: Web Application Log</h5>
                        <pre><code>2024-01-15 14:30:00 INFO  [UserController] Processing login request for user: alice@example.com
2024-01-15 14:30:01 DEBUG [DatabaseService] Executing query: SELECT * FROM users WHERE email = ?
2024-01-15 14:30:02 INFO  [UserController] Login successful, redirecting to dashboard
2024-01-15 14:30:05 ERROR [PaymentService] Payment processing failed: Card declined
2024-01-15 14:30:06 WARN  [SessionManager] Session timeout approaching for user: alice@example.com</code></pre>
                    </div>

                    <h3>3. Web Server Logs</h3>
                    <p>HTTP requests, responses, and server performance metrics.</p>
                    
                    <h4>Access Logs</h4>
                    <p>Record of every HTTP request made to the web server.</p>
                    <pre><code>192.168.1.100 - - [15/Jan/2024:14:30:25 +0000] "GET /index.html HTTP/1.1" 200 2326
192.168.1.101 - - [15/Jan/2024:14:30:26 +0000] "POST /api/login HTTP/1.1" 401 45
192.168.1.102 - - [15/Jan/2024:14:30:27 +0000] "GET /images/siri-logo.png HTTP/1.1" 304 0</code></pre>

                    <h4>Error Logs</h4>
                    <p>Server errors, configuration issues, and request processing problems.</p>
                    <pre><code>[Mon Jan 15 14:30:25 2024] [error] [client 192.168.1.100] File does not exist: /var/www/missing.html
[Mon Jan 15 14:30:26 2024] [warn] [client 192.168.1.101] Timeout waiting for response
[Mon Jan 15 14:30:27 2024] [error] [client 192.168.1.102] Permission denied: /secure/data.txt</code></pre>

                    <h3>4. Database Logs</h3>
                    <p>Query execution, performance metrics, and database operations.</p>
                    
                    <h4>Query Logs</h4>
                    <pre><code>2024-01-15 14:30:25 Query: SELECT * FROM products WHERE category = 'electronics'
2024-01-15 14:30:26 Query: UPDATE users SET last_login = NOW() WHERE id = 12345
2024-01-15 14:30:27 Slow Query: SELECT COUNT(*) FROM orders o JOIN customers c ON o.customer_id = c.id (5.2 seconds)</code></pre>

                    <h4>Error Logs</h4>
                    <pre><code>2024-01-15 14:30:28 ERROR: Duplicate entry '12345' for key 'PRIMARY'
2024-01-15 14:30:29 WARNING: Table 'inventory' is nearly full (95% capacity)
2024-01-15 14:30:30 ERROR: Lost connection to MySQL server during query</code></pre>

                    <h3>5. Security Logs</h3>
                    <p>Authentication events, authorization attempts, and security-related activities.</p>
                    <pre><code>2024-01-15 14:30:25 INFO  [AuthService] Successful login: user=admin, ip=192.168.1.10
2024-01-15 14:30:30 WARN  [AuthService] Failed login attempt: user=admin, ip=192.168.1.100
2024-01-15 14:30:35 ERROR [AuthService] Account locked: user=admin, reason=too_many_failures
2024-01-15 14:30:40 INFO  [AuthService] Password reset requested: user=john.doe@example.com</code></pre>

                    <h3>6. Network Logs</h3>
                    <p>Network traffic, firewall events, and connectivity issues.</p>
                    <pre><code>Jan 15 14:30:25 firewall: ACCEPT TCP 192.168.1.100:443 -> 10.0.0.5:34567
Jan 15 14:30:26 firewall: DENY TCP 192.168.1.200:80 -> 10.0.0.5:22
Jan 15 14:30:27 dhcp: DHCPDISCOVER from 00:11:22:33:44:55 via eth0</code></pre>
                </div>

                {% elif topic == 'common-errors' %}
                <div class="article-content">
                    <h2>Common Log Errors and Their Solutions</h2>
                    <p class="lead">Understanding common error patterns in logs is essential for quick problem resolution. This guide covers the most frequently encountered errors and their typical causes.</p>

                    <h3>HTTP Status Code Errors</h3>
                    
                    <div class="error-category">
                        <h4>4xx Client Errors</h4>
                        <div class="error-details">
                            <div class="error-item">
                                <h5>400 Bad Request</h5>
                                <p><strong>Meaning:</strong> The server cannot process the request due to invalid syntax.</p>
                                <p><strong>Common causes:</strong></p>
                                <ul>
                                    <li>Malformed JSON in request body</li>
                                    <li>Missing required headers</li>
                                    <li>Invalid characters in URL</li>
                                </ul>
                                <p><strong>Resolution:</strong> Validate request format and parameters.</p>
                            </div>

                            <div class="error-item">
                                <h5>401 Unauthorized</h5>
                                <p><strong>Meaning:</strong> Authentication is required or has failed.</p>
                                <p><strong>Common causes:</strong></p>
                                <ul>
                                    <li>Missing or invalid API key</li>
                                    <li>Expired authentication token</li>
                                    <li>Incorrect credentials</li>
                                </ul>
                                <p><strong>Resolution:</strong> Check authentication headers and token validity.</p>
                            </div>

                            <div class="error-item">
                                <h5>404 Not Found</h5>
                                <p><strong>Meaning:</strong> The requested resource does not exist.</p>
                                <p><strong>Common causes:</strong></p>
                                <ul>
                                    <li>Broken links or incorrect URLs</li>
                                    <li>Deleted or moved resources</li>
                                    <li>Typos in API endpoints</li>
                                </ul>
                                <p><strong>Resolution:</strong> Verify URL paths and resource availability.</p>
                            </div>
                        </div>
                    </div>

                    <div class="error-category">
                        <h4>5xx Server Errors</h4>
                        <div class="error-details">
                            <div class="error-item">
                                <h5>500 Internal Server Error</h5>
                                <p><strong>Meaning:</strong> Generic server-side error.</p>
                                <p><strong>Common causes:</strong></p>
                                <ul>
                                    <li>Unhandled exceptions in application code</li>
                                    <li>Database connection failures</li>
                                    <li>Configuration errors</li>
                                    <li>Resource exhaustion (memory, disk)</li>
                                </ul>
                                <p><strong>Resolution:</strong> Check application logs for stack traces and system resources.</p>
                            </div>

                            <div class="error-item">
                                <h5>502 Bad Gateway</h5>
                                <p><strong>Meaning:</strong> Invalid response from upstream server.</p>
                                <p><strong>Common causes:</strong></p>
                                <ul>
                                    <li>Application server is down</li>
                                    <li>Network connectivity issues</li>
                                    <li>Proxy misconfiguration</li>
                                </ul>
                                <p><strong>Resolution:</strong> Check upstream server status and network connectivity.</p>
                            </div>

                            <div class="error-item">
                                <h5>503 Service Unavailable</h5>
                                <p><strong>Meaning:</strong> Server is temporarily unavailable.</p>
                                <p><strong>Common causes:</strong></p>
                                <ul>
                                    <li>Server overload or maintenance</li>
                                    <li>Rate limiting</li>
                                    <li>Circuit breaker activation</li>
                                </ul>
                                <p><strong>Resolution:</strong> Check server load and capacity limits.</p>
                            </div>
                        </div>
                    </div>

                    <h3>Database Error Patterns</h3>
                    <div class="database-errors">
                        <div class="error-pattern">
                            <h5>Connection Errors</h5>
                            <pre><code>ERROR: could not connect to server: Connection refused
ERROR: FATAL: password authentication failed for user "myapp"
ERROR: server closed the connection unexpectedly</code></pre>
                            <p><strong>Solutions:</strong></p>
                            <ul>
                                <li>Verify database server is running</li>
                                <li>Check connection string and credentials</li>
                                <li>Review firewall and network configuration</li>
                            </ul>
                        </div>

                        <div class="error-pattern">
                            <h5>Query Errors</h5>
                            <pre><code>ERROR: relation "missing_table" does not exist
ERROR: column "unknown_column" does not exist
ERROR: syntax error at or near "SELCT"</code></pre>
                            <p><strong>Solutions:</strong></p>
                            <ul>
                                <li>Verify table and column names</li>
                                <li>Check SQL syntax</li>
                                <li>Ensure database schema is up to date</li>
                            </ul>
                        </div>

                        <div class="error-pattern">
                            <h5>Constraint Violations</h5>
                            <pre><code>ERROR: duplicate key value violates unique constraint "users_email_key"
ERROR: null value in column "required_field" violates not-null constraint
ERROR: foreign key constraint "fk_orders_customer" is violated</code></pre>
                            <p><strong>Solutions:</strong></p>
                            <ul>
                                <li>Check for duplicate data before insertion</li>
                                <li>Validate required fields</li>
                                <li>Ensure referenced data exists</li>
                            </ul>
                        </div>
                    </div>

                    <h3>Application Error Patterns</h3>
                    <div class="app-errors">
                        <div class="error-type">
                            <h5>Memory Errors</h5>
                            <pre><code>java.lang.OutOfMemoryError: Java heap space
ERROR: out of memory for query result
MemoryError: Unable to allocate array</code></pre>
                            <p><strong>Solutions:</strong> Increase memory allocation, optimize queries, implement pagination.</p>
                        </div>

                        <div class="error-type">
                            <h5>Timeout Errors</h5>
                            <pre><code>TimeoutException: Request timed out after 30 seconds
ERROR: canceling statement due to statement timeout
Connection timeout: No response after 60 seconds</code></pre>
                            <p><strong>Solutions:</strong> Optimize slow operations, increase timeout values, implement async processing.</p>
                        </div>

                        <div class="error-type">
                            <h5>File System Errors</h5>
                            <pre><code>ERROR: No space left on device
Permission denied: cannot write to /var/log/app.log
FileNotFoundException: /path/to/config.xml not found</code></pre>
                            <p><strong>Solutions:</strong> Clean up disk space, fix file permissions, verify file paths.</p>
                        </div>
                    </div>

                    <h3>Error Analysis Workflow</h3>
                    <ol>
                        <li><strong>Identify:</strong> Extract error message and code</li>
                        <li><strong>Classify:</strong> Determine error type and severity</li>
                        <li><strong>Correlate:</strong> Find related events and patterns</li>
                        <li><strong>Investigate:</strong> Check system state and resources</li>
                        <li><strong>Resolve:</strong> Apply appropriate fix</li>
                        <li><strong>Monitor:</strong> Verify resolution and prevent recurrence</li>
                    </ol>
                </div>

                {% else %}
                <div class="article-content">
                    <h2>Article Content</h2>
                    <p class="lead">This article is currently being developed. Please check back soon for comprehensive content on {{ topic.replace('-', ' ').title() }}.</p>
                    
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        <strong>Coming Soon:</strong> Detailed information about {{ topic.replace('-', ' ').title() }} will be available shortly.
                    </div>
                </div>
                {% endif %}

                <!-- Article Actions -->
                <div class="article-actions mt-5 pt-4 border-top border-secondary">
                    <div class="row">
                        <div class="col-md-6">
                            <h5>Was this helpful?</h5>
                            <div class="btn-group" role="group">
                                <button type="button" class="btn btn-outline-success" onclick="rateArticle('helpful')">
                                    <i class="fas fa-thumbs-up me-1"></i>Yes
                                </button>
                                <button type="button" class="btn btn-outline-danger" onclick="rateArticle('not-helpful')">
                                    <i class="fas fa-thumbs-down me-1"></i>No
                                </button>
                            </div>
                        </div>
                        <div class="col-md-6 text-md-end">
                            <h5>Share this article</h5>
                            <div class="share-buttons">
                                <button class="btn btn-outline-primary btn-sm" onclick="shareArticle('twitter')">
                                    <i class="fab fa-twitter me-1"></i>Twitter
                                </button>
                                <button class="btn btn-outline-primary btn-sm" onclick="shareArticle('linkedin')">
                                    <i class="fab fa-linkedin me-1"></i>LinkedIn
                                </button>
                                <button class="btn btn-outline-secondary btn-sm" onclick="copyUrl()">
                                    <i class="fas fa-link me-1"></i>Copy Link
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </article>
        </div>

        <!-- Sidebar -->
        <div class="col-lg-4">
            <!-- Table of Contents -->
            <div class="server-card sticky-top mb-4" style="top: 100px;">
                <h5 class="text-aqua mb-3">
                    <i class="fas fa-list me-2"></i>Table of Contents
                </h5>
                <div id="tableOfContents">
                    <!-- Generated dynamically -->
                </div>
            </div>

            <!-- Related Articles -->
            <div class="server-card mb-4">
                <h5 class="text-aqua mb-3">
                    <i class="fas fa-link me-2"></i>Related Articles
                </h5>
                <div class="related-articles">
                    <a href="{{ url_for('knowledge_detail', topic='log-types') }}" class="related-link">
                        <i class="fas fa-layer-group me-2"></i>Types of Log Files
                    </a>
                    <a href="{{ url_for('knowledge_detail', topic='analysis-techniques') }}" class="related-link">
                        <i class="fas fa-search me-2"></i>Analysis Techniques
                    </a>
                    <a href="{{ url_for('knowledge_detail', topic='troubleshooting') }}" class="related-link">
                        <i class="fas fa-tools me-2"></i>Troubleshooting Guide
                    </a>
                    <a href="{{ url_for('knowledge_detail', topic='best-practices') }}" class="related-link">
                        <i class="fas fa-star me-2"></i>Best Practices
                    </a>
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="server-card">
                <h5 class="text-aqua mb-3">
                    <i class="fas fa-bolt me-2"></i>Quick Actions
                </h5>
                <div class="quick-actions">
                    <a href="{{ url_for('upload_page') }}" class="btn btn-primary w-100 mb-2">
                        <i class="fas fa-upload me-2"></i>Analyze Your Logs
                    </a>
                    <a href="{{ url_for('assistant') }}" class="btn btn-outline-primary w-100 mb-2">
                        <i class="fas fa-robot me-2"></i>Ask AI Assistant
                    </a>
                    <a href="{{ url_for('knowledge') }}" class="btn btn-outline-secondary w-100">
                        <i class="fas fa-book me-2"></i>Browse All Articles
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    generateTableOfContents();
    setupScrollSpy();
});

function generateTableOfContents() {
    const content = document.querySelector('.article-content');
    const toc = document.getElementById('tableOfContents');
    const headings = content.querySelectorAll('h2, h3, h4');
    
    if (headings.length === 0) {
        toc.innerHTML = '<p class="text-muted small">No sections found</p>';
        return;
    }
    
    const tocList = document.createElement('ul');
    tocList.className = 'toc-list';
    
    headings.forEach((heading, index) => {
        const id = `section-${index}`;
        heading.id = id;
        
        const li = document.createElement('li');
        li.className = `toc-item toc-${heading.tagName.toLowerCase()}`;
        
        const link = document.createElement('a');
        link.href = `#${id}`;
        link.textContent = heading.textContent;
        link.className = 'toc-link';
        
        li.appendChild(link);
        tocList.appendChild(li);
    });
    
    toc.appendChild(tocList);
    
    // Smooth scrolling for TOC links
    document.querySelectorAll('.toc-link').forEach(link => {
        link.addEventListener('click', function(e) {
            e.preventDefault();
            const target = document.querySelector(this.getAttribute('href'));
            if (target) {
                target.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
        });
    });
}

function setupScrollSpy() {
    const sections = document.querySelectorAll('[id^="section-"]');
    const tocLinks = document.querySelectorAll('.toc-link');
    
    function updateActiveTocLink() {
        let current = '';
        sections.forEach(section => {
            const sectionTop = section.offsetTop - 150;
            if (window.pageYOffset >= sectionTop) {
                current = section.getAttribute('id');
            }
        });
        
        tocLinks.forEach(link => {
            link.classList.remove('active');
            if (link.getAttribute('href') === `#${current}`) {
                link.classList.add('active');
            }
        });
    }
    
    window.addEventListener('scroll', updateActiveTocLink);
    updateActiveTocLink(); // Initial call
}

function rateArticle(rating) {
    // Simulate rating submission
    const buttons = document.querySelectorAll('.article-actions .btn-group button');
    buttons.forEach(btn => btn.disabled = true);
    
    const message = rating === 'helpful' ? 
        '<span class="text-success"><i class="fas fa-check me-1"></i>Thank you for your feedback!</span>' :
        '<span class="text-warning"><i class="fas fa-info-circle me-1"></i>We\'ll work to improve this article.</span>';
    
    setTimeout(() => {
        buttons[0].parentNode.innerHTML = message;
    }, 500);
}

function shareArticle(platform) {
    const url = window.location.href;
    const title = document.querySelector('.article-title').textContent;
    
    let shareUrl = '';
    if (platform === 'twitter') {
        shareUrl = `https://twitter.com/intent/tweet?url=${encodeURIComponent(url)}&text=${encodeURIComponent(title)}`;
    } else if (platform === 'linkedin') {
        shareUrl = `https://www.linkedin.com/sharing/share-offsite/?url=${encodeURIComponent(url)}`;
    }
    
    if (shareUrl) {
        window.open(shareUrl, '_blank', 'width=600,height=400');
    }
}

function copyUrl() {
    navigator.clipboard.writeText(window.location.href).then(() => {
        const button = event.target.closest('button');
        const originalHTML = button.innerHTML;
        button.innerHTML = '<i class="fas fa-check me-1"></i>Copied!';
        button.disabled = true;
        
        setTimeout(() => {
            button.innerHTML = originalHTML;
            button.disabled = false;
        }, 2000);
    });
}
</script>
{% endblock %}
